# FRNSW Recalls 90 (v1.0.2)

**Fire and Rescue NSW - Menai Station 90 Recall Management System**

A comprehensive Progressive Web Application (PWA) for managing firefighter recall shifts with fairness, transparency, and accountability.

## ðŸš’ Overview

FRNSW Recalls 90 is designed specifically for Fire and Rescue NSW Menai Station 90 to manage recall shifts efficiently and fairly. The system ensures transparent distribution of recalls based on a fairness algorithm while providing real-time notifications and comprehensive reporting.

### Key Features

- **Fair Recall Distribution**: Algorithm-based assignment considering recall history, hours, and availability
- **Real-time Notifications**: Email and push notifications for new recalls, assignments, and updates
- **Progressive Web App**: Installable on mobile devices with offline capabilities
- **Transparency Reports**: Comprehensive reporting for fairness tracking and accountability
- **Admin Management**: User management, recall creation, and system administration
- **Mobile-first Design**: Optimized for mobile devices with responsive design

## ðŸ—ï¸ Architecture

### Technology Stack

- **Frontend**: React 18, TailwindCSS, PWA
- **Backend**: Node.js, Express.js, Socket.IO
- **Database**: MySQL (MariaDB)
- **Notifications**: SMTP Email + Web Push API
- **Charts**: Chart.js
- **Calendar**: React Big Calendar
- **Authentication**: JWT with bcrypt
- **Process Management**: PM2
- **Real-time**: WebSocket connections via Socket.IO

### Security Features

- HTTPS enforced
- bcrypt password hashing
- JWT token authentication
- Email verification required
- Domain-restricted registration (@fire.nsw.gov.au)
- Approved staff list validation
- Admin audit logging
- Rate limiting
- CSRF protection

## ðŸ“‹ Prerequisites

- **Node.js**: Version 18 or higher
- **MySQL**: Version 8.0 or higher (or MariaDB)
- **SSL Certificate**: For production deployment
- **Domain**: Configured for frnswrecall90.interactivewebs.com

## ðŸ“ Changelog

For detailed information about changes, bug fixes, and new features, see [CHANGELOG.md](./CHANGELOG.md).

**Recent Updates (v1.0.2)**:
- Fixed user registration field mapping issues
- Expanded approved staff list for testing
- Improved deployment script permissions
- Added comprehensive changelog for AI coder collaboration

## ðŸš€ Installation

### 1. Clone and Prepare

```bash
# Navigate to your project directory
cd /path/to/your/project

# Make deployment script executable
chmod +x deploy.sh

# Run deployment script
./deploy.sh
```

### 2. Configure Environment

Edit `backend/.env` with your specific settings:

```env
# Database Configuration
DB_HOST=localhost
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=frnsw_recalls_90

# JWT Secret (generate a strong secret)
JWT_SECRET=your_super_secret_jwt_key_here

# Email Configuration (pre-configured for interactivewebs.com)
SMTP_HOST=mail.interactivewebs.com
SMTP_PORT=587
SMTP_USER=admin
SMTP_PASS=1194Dub!@#
FROM_EMAIL=FRNSWRecalls90@interactivewebs.com

# Application Settings
APP_URL=https://frnswrecall90.interactivewebs.com
PORT=3001
NODE_ENV=production

# Security
BCRYPT_ROUNDS=12
TOKEN_EXPIRY=24h

# VAPID keys will be auto-generated by deploy script
```

### 3. Database Setup

The deployment script will automatically:
- Create the database if MySQL is available
- Import the schema from `database/schema.sql`
- Seed initial data (approved staff list)

Manual database setup:
```sql
CREATE DATABASE frnsw_recalls_90;
USE frnsw_recalls_90;
SOURCE database/schema.sql;
```

### 4. Start Application

```bash
# Start with PM2
pm2 start ecosystem.config.js

# Save PM2 configuration
pm2 save

# Set up PM2 to start on boot
pm2 startup
```

## ðŸ‘¥ User Management

### Default Admin Users

The system comes with three pre-configured admin users that need to be set up after deployment:

1. **David Finley** (Host Admin)
   - Staff Number: 1001
   - Email: david.finley@fire.nsw.gov.au
   - Role: Host Admin (cannot be removed)

2. **Brady Clarke** (Admin)
   - Staff Number: 1002
   - Email: brady.clarke@fire.nsw.gov.au
   - Role: Admin

3. **Ben Miller** (Admin)
   - Staff Number: 1003
   - Email: ben.miller@fire.nsw.gov.au
   - Role: Admin

### Setting Up Admin Passwords

After deployment, run this script to create initial admin users:

```javascript
// Run this in your database or create a setup script
const bcrypt = require('bcrypt');

const adminUsers = [
  {
    staff_number: 1001,
    first_name: 'David',
    last_name: 'Finley',
    email: 'david.finley@fire.nsw.gov.au',
    is_admin: true,
    is_host_admin: true,
    email_verified: true,
    password: 'SetSecurePasswordHere'
  },
  {
    staff_number: 1002,
    first_name: 'Brady',
    last_name: 'Clarke',
    email: 'brady.clarke@fire.nsw.gov.au',
    is_admin: true,
    is_host_admin: false,
    email_verified: true,
    password: 'SetSecurePasswordHere'
  },
  {
    staff_number: 1003,
    first_name: 'Ben',
    last_name: 'Miller',
    email: 'ben.miller@fire.nsw.gov.au',
    is_admin: true,
    is_host_admin: false,
    email_verified: true,
    password: 'SetSecurePasswordHere'
  }
];

// Hash passwords and insert users
```

### Approved Staff List

The system includes a pre-configured approved staff list:
- White, C
- Clarke, B
- Miller, B
- Finley, D

Additional staff can be added through the admin panel by the Host Admin.

## ðŸ“± Features Overview

### For All Users

- **Dashboard**: Overview of upcoming recalls and personal statistics
- **Recalls**: View active recalls and respond with availability
- **Calendar**: Visual calendar view of all recalls
- **Reports**: Transparency reports showing fairness statistics
- **Profile**: Manage notification preferences and account settings

### For Admins

- **Create Recalls**: Schedule new recall shifts
- **Manage Assignments**: Assign users to recalls with fairness algorithm guidance
- **Edit/Cancel Recalls**: Modify or cancel existing recalls
- **User Management**: View user statistics and manage admin privileges (Host Admin only)
- **Reports**: Advanced reporting and data export capabilities

### Real-time Features

- **Live Updates**: Socket.IO powered real-time updates for all users
- **Push Notifications**: Browser push notifications for mobile devices
- **Email Notifications**: HTML email notifications for all recall activities
- **Offline Support**: Service worker enables offline viewing of cached data

## ðŸ”§ Management Commands

### PM2 Process Management

```bash
# Check status
pm2 status

# View logs
pm2 logs frnsw-recalls-90

# Restart application
pm2 restart frnsw-recalls-90

# Stop application
pm2 stop frnsw-recalls-90

# Monitor in real-time
pm2 monit
```

### Database Management

```bash
# Create database backup
mysqldump -u [username] -p frnsw_recalls_90 > backup_$(date +%Y%m%d_%H%M%S).sql

# Restore from backup
mysql -u [username] -p frnsw_recalls_90 < backup_file.sql

# View database size
mysql -u [username] -p -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.tables WHERE table_schema='frnsw_recalls_90';"
```

### Application Logs

```bash
# View application logs
tail -f logs/combined.log

# View error logs only
tail -f logs/err.log

# View output logs only
tail -f logs/out.log
```

## ðŸ”„ Maintenance

The application includes automated maintenance tasks:

### Daily Tasks (2:00 AM)
- Recalculate user recall hours for fairness algorithm

### Weekly Tasks (Sunday 4:00 AM)
- Clean up old audit logs (12+ months)
- Clear expired verification tokens
- Database optimization

### Monthly Tasks (1st of month, 3:00 AM)
- Archive recalls older than 24 months
- Archive related assignments and responses
- Maintain data retention compliance

### Manual Maintenance

```bash
# Access the application and run manual tasks
# Through the admin panel or direct database queries
```

## ðŸ“Š Monitoring

### Health Checks

The application provides health check endpoints:

```bash
# Check application health
curl https://frnswrecall90.interactivewebs.com/health

# Check database connectivity
# Available through admin panel
```

### Performance Monitoring

- PM2 provides built-in monitoring
- Check logs for performance issues
- Monitor database query performance
- Track notification delivery rates

## ðŸ›¡ï¸ Security Considerations

### Password Policies
- Minimum 8 characters
- Must contain uppercase, lowercase, and numbers
- bcrypt hashing with 12 rounds

### Email Security
- Domain restriction to @fire.nsw.gov.au
- Email verification required
- HTML emails with inline CSS for compatibility

### Data Protection
- 24-month data retention
- Automatic archival of old records
- Audit logging for all admin actions
- HTTPS enforced in production

## ðŸ› Troubleshooting

### Common Issues

1. **Database Connection Issues**
   ```bash
   # Check database status
   sudo systemctl status mysql
   
   # Check connection from app
   mysql -h[host] -u[user] -p[password] [database]
   ```

2. **Email Notifications Not Working**
   - Verify SMTP settings in `.env`
   - Check firewall allows outbound port 587
   - Test email configuration

3. **Push Notifications Not Working**
   - Ensure VAPID keys are generated
   - Check HTTPS is enabled
   - Verify service worker registration

4. **Application Won't Start**
   ```bash
   # Check PM2 status
   pm2 status
   
   # View detailed logs
   pm2 logs frnsw-recalls-90 --lines 100
   
   # Check Node.js version
   node --version
   ```

### Log Analysis

```bash
# Search for errors in logs
grep -i error logs/combined.log

# Search for specific user actions
grep "user_id:1001" logs/combined.log

# Monitor real-time activity
tail -f logs/combined.log | grep -i "recall"
```

## ðŸ“ž Support

For technical support or issues:

1. Check the logs first: `pm2 logs frnsw-recalls-90`
2. Review this documentation
3. Contact the development team
4. Report issues through the admin panel

## ðŸš’ Fire and Rescue NSW

This application is specifically designed for:

**Fire and Rescue NSW - Menai Station 90**
- Station Number: 90
- Location: Menai, NSW
- Purpose: Recall shift management
- Users: FRNSW firefighters and administrators

---

**Built with â¤ï¸ for Fire and Rescue NSW**

*Ensuring fair, transparent, and efficient recall management for our firefighters.*